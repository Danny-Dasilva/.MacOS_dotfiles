# --- 1. General Settings ---
set -g status-position top       # Move bar to the top
set -g base-index 1              # Start windows at 1 (VS Code style)
set -g pane-base-index 1
set -g mouse on                  # Enable mouse for scrolling/clicking
set -g default-terminal "tmux-256color"
set -ga terminal-overrides ",xterm-256color:Tc"
set -g history-limit 5000

# Remap prefix from 'C-b' to 'C-y'
unbind C-b
set-option -g prefix C-y
bind-key C-y send-prefix

# Split panes using | and -
bind | split-window -h
bind - split-window -v
unbind '"'
unbind %

# Switch panes using Alt+hjkl
bind -n M-h select-pane -L
bind -n M-l select-pane -R
bind -n M-k select-pane -U
bind -n M-j select-pane -D

# Reload config
bind r source-file ~/.tmux.conf \; display "Reloaded tmux config!"

# Decrease command delay
set -sg escape-time 1

# --- 2. The SSH Project Menu ---
# Scans ~/.ssh/config. When selected, it connects and resumes the remote tmux session.
bind S run-shell 'tmux display-menu -x P -y P -T "#[fg=magenta,bold] 󱘖 Remote Workspaces " \
    $(grep -iP "^Host ([^*]+)$" ~/.ssh/config | awk "{print \$2}" | while read -r host; do \
        echo "\"$host\" \"$host\" \"new-window -n $host '\''ssh -t $host \\\"tmux new -A -s main\\\"'\''\""; \
    done) \
    "" \
    "󰜺 Close Menu" q ""'

# --- 3. Plugins ---
set -g @plugin 'tmux-plugins/tpm'
set -g @plugin 'tmux-plugins/tmux-sensible'
set -g @plugin 'tmux-plugins/tmux-resurrect'
set -g @plugin 'tmux-plugins/tmux-continuum'
set -g @plugin 'christoomey/vim-tmux-navigator'
set -g @plugin 'catppuccin/tmux#v2.1.2'

# Continuum settings
set -g @continuum-restore 'on'

# --- 4. Catppuccin Theme Customization ---
set -g @catppuccin_flavor 'mocha'
set -g @catppuccin_window_status_style "rounded"
set -g @catppuccin_window_default_text " #W"
set -g @catppuccin_window_current_text " #W"
set -g status-left "#[fg=#a6e3a1,bg=default] 󰐕 #[default]"
set -g status-right "#[fg=#f38ba8,bg=default] 󰅖 #[default] #{E:@catppuccin_status_session}"

# --- 5. Clickable Status Bar ---
# Click + (left side) to create new window
bind -n MouseDown1StatusLeft new-window
# Click × (right side) to close current window
bind -n MouseDown1StatusRight confirm-before -p "Close window '#W'? (y/n)" kill-window
# Middle-click on any window tab to close it
bind -n MouseDown2Status kill-window

# --- 6. Help Menu (prefix + ?) ---
bind ? display-menu -T "#[fg=#cba6f7,bold]  Tmux Shortcuts " -x C -y C \
    "" \
    "#[fg=#a6e3a1,bold]─── Windows ───" "" "" \
    "  New Window          prefix + c" c "new-window" \
    "  Close Window        prefix + &" & "confirm-before kill-window" \
    "  Next Window         prefix + n" n "next-window" \
    "  Prev Window         prefix + p" p "previous-window" \
    "  Rename Window       prefix + ," , "command-prompt -I '#W' 'rename-window \"%%\"'" \
    "" \
    "#[fg=#89b4fa,bold]─── Panes ───" "" "" \
    "  Split Horizontal    prefix + |" | "split-window -h" \
    "  Split Vertical      prefix + -" - "split-window -v" \
    "  Close Pane          prefix + x" x "confirm-before kill-pane" \
    "  Zoom Pane           prefix + z" z "resize-pane -Z" \
    "  Navigate            Alt + h/j/k/l" "" "" \
    "" \
    "#[fg=#f9e2af,bold]─── Sessions ───" "" "" \
    "  SSH Menu            prefix + S" S "run-shell 'tmux display-menu -x P -y P -T \"#[fg=magenta,bold] 󱘖 Remote Workspaces \" \$(grep -iP \"^Host ([^*]+)\$\" ~/.ssh/config | awk \"{print \\\$2}\" | while read -r host; do echo \"\\\"\$host\\\" \\\"\$host\\\" \\\"new-window -n \$host '\\''ssh -t \$host \\\\\\\"tmux new -A -s main\\\\\\\"'\\''\\\"\" ; done) \"\" \"󰜺 Close Menu\" q \"\"'" \
    "  Save Session        prefix + Ctrl-s" C-s "run-shell '~/.tmux/plugins/tmux-resurrect/scripts/save.sh'" \
    "  Restore Session     prefix + Ctrl-r" C-r "run-shell '~/.tmux/plugins/tmux-resurrect/scripts/restore.sh'" \
    "  Detach              prefix + d" d "detach-client" \
    "" \
    "#[fg=#f38ba8,bold]─── Other ───" "" "" \
    "  Reload Config       prefix + r" r "source-file ~/.tmux.conf; display 'Reloaded!'" \
    "  Command Prompt      prefix + :" : "command-prompt" \
    "" \
    "#[fg=#6c7086]─── Mouse ───" "" "" \
    "  Click 󰐕             New window" "" "" \
    "  Click 󰅖             Close window" "" "" \
    "  Middle-click tab    Close that window" "" "" \
    "" \
    "󰜺 Close" q ""

# Initialize TPM (Keep this at the very bottom)
run '~/.tmux/plugins/tpm/tpm'
